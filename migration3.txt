-- SoulMatch Migration
-- version: 8.0
-- Adds support for multiple images on events and places.

-- 1. Create event_images table
CREATE TABLE "public"."event_images" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "event_id" bigint NOT NULL REFERENCES public.events(id) ON DELETE CASCADE,
    "image_url" text NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

-- 2. Create place_images table
CREATE TABLE "public"."place_images" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "place_id" bigint NOT NULL REFERENCES public.places(id) ON DELETE CASCADE,
    "image_url" text NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

-- 3. Migrate existing single images into the new tables to preserve data
INSERT INTO public.event_images (event_id, image_url, created_at)
SELECT id, image_url, created_at FROM public.events WHERE image_url IS NOT NULL;

INSERT INTO public.place_images (place_id, image_url, created_at)
SELECT id, image_url, created_at FROM public.places WHERE image_url IS NOT NULL;

-- 4. Enable RLS and set up policies
ALTER TABLE public.event_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.place_images ENABLE ROW LEVEL SECURITY;

-- Allow public read access
CREATE POLICY "Allow public read access to event images" ON public.event_images FOR SELECT USING (true);
CREATE POLICY "Allow public read access to place images" ON public.place_images FOR SELECT USING (true);

-- Allow organization owners to manage images for their events/places
CREATE POLICY "Allow org owners to manage event images" ON public.event_images FOR ALL USING (
    (SELECT organization_id FROM public.events WHERE id = event_id) IN (
        SELECT id FROM public.organizations WHERE auth_id = auth.uid()
    )
);
CREATE POLICY "Allow org owners to manage place images" ON public.place_images FOR ALL USING (
    (SELECT organization_id FROM public.places WHERE id = place_id) IN (
        SELECT id FROM public.organizations WHERE auth_id = auth.uid()
    )
);

-- 5. Grants
GRANT SELECT ON public.event_images, public.place_images TO authenticated, anon;
GRANT INSERT, UPDATE, DELETE ON public.event_images, public.place_images TO authenticated;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO authenticated;
