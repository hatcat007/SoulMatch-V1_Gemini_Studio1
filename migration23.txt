-- Migration 23: Update RLS policies for Event Chat Visibility

-- 1. Create a helper function to check if the current user is a participant of a given event.
-- This is needed for the updated RLS policy on message_threads.
CREATE OR REPLACE FUNCTION public.is_event_participant(p_event_id bigint)
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
  -- get_current_user_id() is in a previous migration and returns the public.users.id
  SELECT EXISTS (
    SELECT 1 FROM public.event_participants WHERE event_id = p_event_id AND user_id = get_current_user_id()
  );
$$;

-- 2. Grant execution rights to authenticated users.
GRANT EXECUTE ON FUNCTION public.is_event_participant(bigint) TO authenticated;


-- 3. Update RLS policies on message_threads for better visibility of event chats.
-- Drop old policies to avoid conflicts
DROP POLICY IF EXISTS "Allow access to own message threads" ON public.message_threads;
DROP POLICY IF EXISTS "Allow access to own and related event message threads" ON public.message_threads;
DROP POLICY IF EXISTS "Allow read access to own and related event threads" ON public.message_threads;
DROP POLICY IF EXISTS "Allow modification of own message threads" ON public.message_threads;
DROP POLICY IF EXISTS "Allow update on own message threads" ON public.message_threads;
DROP POLICY IF EXISTS "Allow delete on own message threads" ON public.message_threads;


-- New SELECT policy: Allows a user to SEE a thread if they are a participant of the thread,
-- OR if it's an event chat and they are a participant of the parent event.
CREATE POLICY "Allow read access to own and related event threads"
ON public.message_threads
FOR SELECT
USING (
  is_thread_participant(id)
  OR
  (is_event_chat = true AND event_id IS NOT NULL AND is_event_participant(event_id))
);

-- New modification policies: A user can only UPDATE or DELETE a thread
-- if they are an actual participant of the chat thread itself.
-- Direct INSERTs by users are not intended; they happen via SECURITY DEFINER functions.
CREATE POLICY "Allow update on own message threads"
ON public.message_threads
FOR UPDATE
USING (is_thread_participant(id))
WITH CHECK (is_thread_participant(id)); -- WITH CHECK is also good practice for UPDATE

CREATE POLICY "Allow delete on own message threads"
ON public.message_threads
FOR DELETE
USING (is_thread_participant(id));