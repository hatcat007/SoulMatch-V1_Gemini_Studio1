-- Migration 33: Add RPC function to sync organization name changes to host user profile

CREATE OR REPLACE FUNCTION public.update_organization_host_user(
    p_old_host_name text,
    p_new_host_name text,
    p_old_org_name text,
    p_new_org_name text
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
    v_org_id bigint;
    v_host_user_id bigint;
BEGIN
    -- Security Check: Verify that the user calling this function is the owner of the organization profile being implicitly updated.
    SELECT id INTO v_org_id FROM public.organizations WHERE auth_id = auth.uid() LIMIT 1;
    
    IF v_org_id IS NULL THEN
        RAISE EXCEPTION 'Permission denied. Caller is not a valid organization.';
    END IF;

    -- Find the host user based on the OLD names. This is crucial for finding the correct record to update.
    SELECT id INTO v_host_user_id 
    FROM public.users 
    WHERE name = p_old_host_name AND bio = 'Kontaktperson for ' || p_old_org_name
    LIMIT 1;

    -- If a host user is found, update it with the NEW names.
    IF v_host_user_id IS NOT NULL THEN
        UPDATE public.users
        SET 
            name = p_new_host_name,
            bio = 'Kontaktperson for ' || p_new_org_name
        WHERE id = v_host_user_id;
    END IF;
END;
$$;

-- Grant execute permission to authenticated users (organizations).
GRANT EXECUTE ON FUNCTION public.update_organization_host_user(text, text, text, text) TO authenticated;
