-- Migration: Switch from Big Five `user_traits` to 4-dimension `user_personality_dimensions`

-- 1. Drop the old user_traits table
DROP TABLE IF EXISTS "public"."user_traits" CASCADE;

-- 2. Create the new user_personality_dimensions table
CREATE TABLE "public"."user_personality_dimensions" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id" bigint NOT NULL REFERENCES "public"."users"(id) ON DELETE CASCADE,
    "dimension" character varying(2) NOT NULL,
    "dominant_trait" character varying(1) NOT NULL,
    "score" smallint NOT NULL,
    "description" text NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    CONSTRAINT "user_personality_dimensions_user_id_dimension_key" UNIQUE (user_id, dimension)
);

-- 3. Enable Row Level Security and define policies
ALTER TABLE public.user_personality_dimensions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access to personality dimensions"
ON public.user_personality_dimensions
FOR SELECT USING (true);

CREATE POLICY "Allow users to manage their own personality dimensions"
ON public.user_personality_dimensions
FOR ALL
USING ((SELECT auth_id FROM public.users WHERE id = user_id) = auth.uid());

-- 4. Grant permissions to authenticated users
GRANT ALL ON "public"."user_personality_dimensions" TO "authenticated";
