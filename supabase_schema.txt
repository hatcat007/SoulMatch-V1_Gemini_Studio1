CREATE TABLE "public"."users" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "age" smallint,
    "avatar_url" text,
    "online" boolean DEFAULT false,
    "bio" text,
    "location" text,
    "personality_type" character varying(4),
    "emojis" text[],
    "personality_test_completed" boolean DEFAULT false NOT NULL,
    "is_admin" boolean DEFAULT false NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    "auth_id" uuid UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE
);

CREATE TABLE "public"."interests" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" text NOT NULL UNIQUE
);

CREATE TABLE "public"."user_interests" (
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "interest_id" bigint NOT NULL REFERENCES public.interests(id) ON DELETE CASCADE,
    PRIMARY KEY (user_id, interest_id)
);

CREATE TABLE "public"."user_profile_images" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "image_url" text NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."user_traits" (
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "trait" character varying NOT NULL,
    "value" smallint,
    PRIMARY KEY (user_id, trait)
);

CREATE TABLE "public"."organizations" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "logo_url" text,
    "address" text,
    "description" text,
    "phone" character varying,
    "email" character varying,
    "website" character varying,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    "auth_id" uuid UNIQUE REFERENCES auth.users(id) ON DELETE SET NULL
);

CREATE TABLE "public"."organization_opportunities" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "name" character varying,
    "icon" character varying
);

CREATE TABLE "public"."organization_updates" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "image_url" text
);

CREATE TABLE "public"."events" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "title" character varying,
    "time" timestamptz,
    "host_name" character varying,
    "host_avatar_url" text,
    "icon" character varying,
    "color" character varying,
    "category" character varying,
    "description" text,
    "image_url" text,
    "organization_id" bigint REFERENCES public.organizations(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."event_participants" (
    "event_id" bigint NOT NULL REFERENCES public.events(id) ON DELETE CASCADE,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    PRIMARY KEY (event_id, user_id)
);

CREATE TABLE "public"."places" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "offer" text,
    "address" text,
    "user_count" integer,
    "user_images" text[],
    "icon" character varying,
    "category" character varying,
    "description" text,
    "is_sponsored" boolean,
    "phone" character varying,
    "opening_hours" text,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    "organization_id" bigint REFERENCES public.organizations(id) ON DELETE CASCADE
);

CREATE TABLE "public"."message_threads" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "last_message" text,
    "timestamp" timestamptz,
    "unread_count" integer,
    "match_timestamp" timestamptz,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."message_thread_participants" (
    "thread_id" bigint NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    PRIMARY KEY (thread_id, user_id)
);

CREATE TABLE "public"."messages" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "thread_id" bigint NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
    "sender_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "text" text,
    "image_url" text,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."friends" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id_1" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "user_id_2" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "status" character varying NOT NULL DEFAULT 'pending', -- pending, accepted, blocked
    "action_user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    CONSTRAINT "friends_user_order_check" CHECK (user_id_1 < user_id_2),
    UNIQUE (user_id_1, user_id_2)
);

CREATE TABLE "public"."user_reports" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "reporter_user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "reported_user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "reason" text NOT NULL,
    "comment" text,
    "status" character varying DEFAULT 'new' NOT NULL, -- new, under_review, resolved
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."checkins" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "place_id" bigint NOT NULL REFERENCES public.places(id) ON DELETE CASCADE,
    "user_id_1" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "user_id_2" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);