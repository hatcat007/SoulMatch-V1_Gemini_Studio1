-- SoulMatch Supabase Schema
-- version: 2.0

-- 1. Drop existing tables in reverse order of creation to avoid foreign key constraints
DROP TABLE IF EXISTS "public"."user_traits";
DROP TABLE IF EXISTS "public"."event_participants";
DROP TABLE IF EXISTS "public"."message_thread_participants";
DROP TABLE IF EXISTS "public"."message_threads";
DROP TABLE IF EXISTS "public"."organization_updates";
DROP TABLE IF EXISTS "public"."organization_opportunities";
DROP TABLE IF EXISTS "public"."places";
DROP TABLE IF EXISTS "public"."events";
DROP TABLE IF EXISTS "public"."organizations";
DROP TABLE IF EXISTS "public"."users";

-- 2. Create Tables
CREATE TABLE "public"."users" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "age" smallint,
    "avatar_url" text,
    "online" boolean DEFAULT false,
    "bio" text,
    "location" text,
    "personality_type" character varying(4),
    "created_at" timestamp with time zone DEFAULT now() NOT NULL
);

CREATE TABLE "public"."organizations" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "logo_url" text,
    "address" text,
    "description" text,
    "phone" character varying,
    "email" character varying,
    "website" character varying,
    "created_at" timestamp with time zone DEFAULT now() NOT NULL
);

CREATE TABLE "public"."organization_opportunities" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "name" character varying,
    "icon" character varying
);

CREATE TABLE "public"."organization_updates" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "image_url" text
);

CREATE TABLE "public"."events" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "title" character varying,
    "time" text,
    "host_name" character varying,
    "host_avatar_url" text,
    "icon" character varying,
    "color" character varying,
    "category" character varying,
    "description" text,
    "organization_id" bigint REFERENCES public.organizations(id),
    "created_at" timestamp with time zone DEFAULT now() NOT NULL
);

CREATE TABLE "public"."places" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "offer" text,
    "address" text,
    "user_count" integer,
    "user_images" text[],
    "icon" character varying,
    "category" character varying,
    "description" text,
    "is_sponsored" boolean,
    "phone" character varying,
    "opening_hours" text,
    "created_at" timestamp with time zone DEFAULT now() NOT NULL
);

CREATE TABLE "public"."event_participants" (
    "event_id" bigint NOT NULL REFERENCES public.events(id) ON DELETE CASCADE,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    PRIMARY KEY (event_id, user_id)
);

CREATE TABLE "public"."user_traits" (
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "trait" character varying NOT NULL,
    "value" smallint,
    PRIMARY KEY (user_id, trait)
);

CREATE TABLE "public"."message_threads" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "last_message" text,
    "timestamp" text,
    "unread_count" integer,
    "match_timestamp" timestamptz
);

CREATE TABLE "public"."message_thread_participants" (
    "thread_id" bigint NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    PRIMARY KEY (thread_id, user_id)
);


-- 3. Insert Data
-- Note: User IDs are explicitly set to match mock data.
ALTER TABLE "public"."users" ALTER COLUMN "id" RESTART WITH 1;
INSERT INTO "public"."users" ("id", "name", "age", "avatar_url", "online", "bio", "location", "personality_type") VALUES
(1, 'Anne', 24, 'https://picsum.photos/id/1011/100/100', true, 'Kreativt menneske som elsker film, gaming, katte og g√•ture. Lad os m√∏des til en god kaffe üòä', 'Aalborg, Denmark', 'INFJ'),
(2, 'Jens', 26, 'https://picsum.photos/id/1025/100/100', true, NULL, NULL, NULL),
(3, 'Sofie', 22, 'https://picsum.photos/id/1012/100/100', true, NULL, NULL, NULL),
(4, 'Victoria', 25, 'https://picsum.photos/id/1013/100/100', false, NULL, NULL, NULL),
(101, 'Chris', 20, 'https://i.pravatar.cc/80?u=101', true, NULL, NULL, NULL),
(102, 'S√∏ren', 22, 'https://i.pravatar.cc/80?u=102', false, NULL, NULL, NULL),
(103, 'Jens', 20, 'https://i.pravatar.cc/80?u=103', true, NULL, NULL, NULL),
(104, 'Chris', 20, 'https://i.pravatar.cc/80?u=104', false, NULL, NULL, NULL),
(105, 'Ib', 20, 'https://i.pravatar.cc/80?u=105', true, NULL, NULL, NULL),
(999, 'Mig', 25, 'https://i.pravatar.cc/80?u=999', true, NULL, NULL, NULL);
SELECT setval('public.users_id_seq', (SELECT MAX(id) FROM public.users));


ALTER TABLE "public"."organizations" ALTER COLUMN "id" RESTART WITH 1;
INSERT INTO "public"."organizations" ("id", "name", "logo_url", "address", "description", "phone", "email", "website") VALUES
(1, 'SIND Ungdom Aalborg', 'https://i.imgur.com/8S8V5c2.png', 'Danmarksgade 52, Aalborg, Denmark', 'SIND Ungdom i Aalborg er et klubtilbud for unge psykisk s√•rbare i alderen 16-35 √•r.', '+45 12 34 56 78', 'info@sind-aalborg.dk', 'www.sind-aalborg.dk'),
(2, 'Studenterhuset Aalborg', 'https://i.imgur.com/fL5FfJ4.png', 'Gammeltorv 10, 9000 Aalborg', 'Aalborgs internationale studenterhus. Vi arrangerer koncerter, debatter, fester og meget mere.', '+45 98 76 54 32', 'info@studenterhuset.dk', 'www.studenterhuset.dk'),
(3, 'Ventilen Aalborg', 'https://i.imgur.com/h5r8uGk.png', 'Kirkeg√•rdsgade 2, 9000 Aalborg', 'Et m√∏dested for unge, der f√∏ler sig ensomme. Her kan du m√∏de andre unge og v√¶re en del af et f√¶llesskab.', '+45 11 22 33 44', 'aalborg@ventilen.dk', 'www.ventilen.dk');
SELECT setval('public.organizations_id_seq', (SELECT MAX(id) FROM public.organizations));

INSERT INTO "public"."organization_opportunities" (organization_id, name, icon) VALUES
(1, 'F√¶llesspisning', 'üçΩÔ∏è'), (1, 'Br√¶tspil', 'üé≤'), (1, 'F√¶lles snak', 'üí¨'), (1, 'Kreativt v√¶rksted', 'üé®'),
(2, 'Koncerter', 'üé∏'), (2, 'Debatter', 'üéôÔ∏è'), (2, 'F√¶llesskab', 'üë•'),
(3, 'Br√¶tspil', 'üé≤'), (3, 'Filmhygge', 'üé¨'), (3, 'Madlavning', 'üç≥');

INSERT INTO "public"."organization_updates" (organization_id, image_url) VALUES
(1, 'https://i.imgur.com/K0uX4p5.png'), (1, 'https://i.imgur.com/5lGqYJ0.png');


ALTER TABLE "public"."events" ALTER COLUMN "id" RESTART WITH 1;
INSERT INTO "public"."events" ("id", "title", "time", "host_name", "host_avatar_url", "icon", "color", "category", "description", "organization_id") VALUES
(1, 'Musik koncert sammen', 'Lige nu', 'Jesper fra Studenterhuset Aalborg', 'https://picsum.photos/id/237/40/40', 'üé∏', 'bg-yellow-100', 'Musik', 'Kom og h√∏r Andreas Odbjerg.\nVi gir den f√∏rste √∏l üç∫ #stopensomhed', 2),
(2, 'F√¶lles spisning', 'Om 31 min', 'SIND Ungdom Aalborg', 'https://i.imgur.com/8S8V5c2.png', 'üçΩÔ∏è', 'bg-teal-100', 'Mad', 'Vi m√∏des til en hyggelig aften med god mad og snak. Alle er velkomne, og vi laver maden sammen. Medbring godt hum√∏r!', 1),
(3, 'F√¶lles br√¶tspil', 'I dag klokken 18:00', 'Ventilen Aalborg', 'https://picsum.photos/id/239/40/40', 'üé≤', 'bg-green-100', 'Br√¶tspil', 'Er du til Settlers, Bezzerwizzer eller noget helt tredje? Kom og v√¶r med til en aften i br√¶tspillets tegn. Vi har masser af spil, men tag ogs√• gerne dit eget yndlingsspil med.', 3);
SELECT setval('public.events_id_seq', (SELECT MAX(id) FROM public.events));

INSERT INTO "public"."event_participants" ("event_id", "user_id") VALUES
(1, 101), (1, 102), (1, 103), (1, 104), (1, 105),
(2, 1), (2, 2), (2, 3),
(3, 101), (3, 2), (3, 4);

ALTER TABLE "public"."places" ALTER COLUMN "id" RESTART WITH 1;
INSERT INTO "public"."places" ("id", "name", "offer", "address", "user_count", "user_images", "icon", "category", "description", "is_sponsored", "phone", "opening_hours") VALUES
(1, 'Espresso House', '2 x gratis kaffe', 'Bispensgade 16, 9000 Aalborg', 209, ARRAY['https://picsum.photos/id/10/30/30', 'https://picsum.photos/id/20/30/30'], '‚òï', 'Caf√©', 'Espresso House er Nordens st√∏rste kaffebark√¶de.', true, '+45 12 34 56 78', 'Man-Fre: 07:30 - 19:00'),
(2, 'Heidis bier bar', '25% rabat p√• hele regningen', 'Jomfru Anes G√•rd 5, 9000 Aalborg', 151, ARRAY['https://picsum.photos/id/30/30/30', 'https://picsum.photos/id/40/30/30'], 'üçª', 'Bar', 'Kom og oplev √¶gte afterski-stemning midt i Aalborg!', false, '+45 87 65 43 21', 'Tors-L√∏r: 20:00 - 05:00'),
(3, 'McDonalds', 'Gratis cheeseburger ved k√∏b af menu', 'Nytorv 2, 9000 Aalborg', 97, ARRAY['https://picsum.photos/id/50/30/30', 'https://picsum.photos/id/60/30/30'], 'üçî', 'Restaurant', 'Et velkendt og uformelt sted at m√∏des.', true, '+45 98 76 54 32', 'Alle dage: 10:00 - 01:00');
SELECT setval('public.places_id_seq', (SELECT MAX(id) FROM public.places));

INSERT INTO "public"."user_traits" ("user_id", "trait", "value") VALUES
(1, 'Abstrakt opfattelse', 70), (1, 'Emotionel t√¶nkning', 80), (1, 'Rationel t√¶nkning', 40), (1, 'Konkret opfattelse', 60);

ALTER TABLE "public"."message_threads" ALTER COLUMN "id" RESTART WITH 1;
INSERT INTO "public"."message_threads" ("id", "last_message", "timestamp", "unread_count", "match_timestamp") VALUES
(1, 'Super! Vi ses i bio i morgen üòä', '18:43', 3, (now() - interval '1 day 10 hours')),
(2, 'Omg! Vildt samme her!', '16:43', 0, NULL),
(3, 'Super fedt, har det p√• samme m√•de', '14:43', 0, NULL),
(4, 'Yeeeeeeah üëç', '10:43', 0, NULL);
SELECT setval('public.message_threads_id_seq', (SELECT MAX(id) FROM public.message_threads));

-- Assuming user with id=999 is the current user.
INSERT INTO "public"."message_thread_participants" (thread_id, user_id) VALUES
(1, 1), (1, 999),
(2, 4), (2, 999),
(3, 2), (3, 999),
(4, 3), (4, 999);

-- 4. Row Level Security (RLS) Policies
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organization_opportunities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organization_updates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.places ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.event_participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_traits ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.message_threads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.message_thread_participants ENABLE ROW LEVEL SECURITY;

-- Policies for public read access
CREATE POLICY "Allow read access to all authenticated users" ON public.users FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.organizations FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.organization_opportunities FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.organization_updates FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.events FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.places FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.event_participants FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow read access to all authenticated users" ON public.user_traits FOR SELECT USING (auth.role() = 'authenticated');

-- Policies for message threads (only participants can see)
CREATE POLICY "Allow read access to thread participants" ON public.message_threads FOR SELECT
  USING (id IN (
    SELECT thread_id FROM public.message_thread_participants WHERE user_id = auth.uid()
  ));
CREATE POLICY "Allow read access to thread participants" ON public.message_thread_participants FOR SELECT
  USING (user_id = auth.uid() OR thread_id IN (
    SELECT thread_id FROM public.message_thread_participants WHERE user_id = auth.uid()
  ));

-- Policies for users to manage their own data
CREATE POLICY "Allow users to update their own profile" ON public.users
FOR UPDATE USING (auth.uid() = id) WITH CHECK (auth.uid() = id);

-- Grant usage on schema and sequences
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA public TO authenticated;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO anon;
