-- SoulMatch Supabase Schema & Migration
-- version: 6.0

-- Section 1: Table Dropping
-- Drop tables in reverse order of dependency, using CASCADE to handle RLS policies and other dependencies.
DROP TABLE IF EXISTS "public"."checkins" CASCADE;
DROP TABLE IF EXISTS "public"."user_reports" CASCADE;
DROP TABLE IF EXISTS "public"."friends" CASCADE;
DROP TABLE IF EXISTS "public"."messages" CASCADE;
DROP TABLE IF EXISTS "public"."user_profile_images" CASCADE;
DROP TABLE IF EXISTS "public"."message_thread_participants" CASCADE;
DROP TABLE IF EXISTS "public"."user_traits" CASCADE;
DROP TABLE IF EXISTS "public"."event_participants" CASCADE;
DROP TABLE IF EXISTS "public"."organization_updates" CASCADE;
DROP TABLE IF EXISTS "public"."organization_opportunities" CASCADE;
DROP TABLE IF EXISTS "public"."places" CASCADE;
DROP TABLE IF EXISTS "public"."message_threads" CASCADE;
DROP TABLE IF EXISTS "public"."events" CASCADE;
DROP TABLE IF EXISTS "public"."organizations" CASCADE;
DROP TABLE IF EXISTS "public"."user_interests" CASCADE;
DROP TABLE IF EXISTS "public"."interests" CASCADE;
DROP TABLE IF EXISTS "public"."users" CASCADE;

-- Section 2: Table Creation
CREATE TABLE "public"."users" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "age" smallint,
    "avatar_url" text,
    "online" boolean DEFAULT false,
    "bio" text,
    "location" text,
    "personality_type" character varying(4),
    "emojis" text[],
    "personality_test_completed" boolean DEFAULT false NOT NULL,
    "is_admin" boolean DEFAULT false NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    "auth_id" uuid UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE
);

CREATE TABLE "public"."interests" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" text NOT NULL UNIQUE
);

CREATE TABLE "public"."user_interests" (
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "interest_id" bigint NOT NULL REFERENCES public.interests(id) ON DELETE CASCADE,
    PRIMARY KEY (user_id, interest_id)
);

CREATE TABLE "public"."user_profile_images" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "image_url" text NOT NULL,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."user_traits" (
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "trait" character varying NOT NULL,
    "value" smallint,
    PRIMARY KEY (user_id, trait)
);

CREATE TABLE "public"."organizations" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "logo_url" text,
    "address" text,
    "description" text,
    "phone" character varying,
    "email" character varying,
    "website" character varying,
    "host_name" character varying,
    "organization_type" character varying,
    "facebook_url" character varying,
    "emojis" text[],
    "created_at" timestamptz DEFAULT now() NOT NULL,
    "auth_id" uuid UNIQUE REFERENCES auth.users(id) ON DELETE SET NULL
);

CREATE TABLE "public"."organization_opportunities" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "name" character varying,
    "icon" character varying
);

CREATE TABLE "public"."organization_updates" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "image_url" text
);

CREATE TABLE "public"."events" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "title" character varying,
    "time" timestamptz,
    "host_name" character varying,
    "host_avatar_url" text,
    "icon" character varying,
    "color" character varying,
    "category" character varying,
    "description" text,
    "image_url" text,
    "address" text,
    "organization_id" bigint REFERENCES public.organizations(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."event_participants" (
    "event_id" bigint NOT NULL REFERENCES public.events(id) ON DELETE CASCADE,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    PRIMARY KEY (event_id, user_id)
);

CREATE TABLE "public"."places" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" character varying,
    "offer" text,
    "address" text,
    "user_count" integer,
    "user_images" text[],
    "icon" character varying,
    "category" character varying,
    "description" text,
    "is_sponsored" boolean,
    "phone" character varying,
    "opening_hours" text,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    "organization_id" bigint REFERENCES public.organizations(id) ON DELETE CASCADE
);

CREATE TABLE "public"."message_threads" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "last_message" text,
    "timestamp" timestamptz,
    "unread_count" integer,
    "match_timestamp" timestamptz,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."message_thread_participants" (
    "thread_id" bigint NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    PRIMARY KEY (thread_id, user_id)
);

CREATE TABLE "public"."messages" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "thread_id" bigint NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
    "sender_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "text" text,
    "image_url" text,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."friends" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id_1" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "user_id_2" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "status" character varying NOT NULL DEFAULT 'pending', -- pending, accepted, blocked
    "action_user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL,
    CONSTRAINT "friends_user_order_check" CHECK (user_id_1 < user_id_2),
    UNIQUE (user_id_1, user_id_2)
);

CREATE TABLE "public"."user_reports" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "reporter_user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "reported_user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "reason" text NOT NULL,
    "comment" text,
    "status" character varying DEFAULT 'new' NOT NULL, -- new, under_review, resolved
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE "public"."checkins" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "place_id" bigint NOT NULL REFERENCES public.places(id) ON DELETE CASCADE,
    "user_id_1" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "user_id_2" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

-- Section 3: Seed Data
-- Bypassing RLS for seeding.
ALTER TABLE public.users DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.interests DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_interests DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_profile_images DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_traits DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.organizations DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.events DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.message_threads DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.message_thread_participants DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.event_participants DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.friends DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_reports DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.places DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.checkins DISABLE ROW LEVEL SECURITY;

INSERT INTO "public"."users" ("id", "name", "age", "avatar_url", "online", "bio", "location", "personality_type", "emojis", "personality_test_completed", "is_admin") VALUES
(1, 'Anne', 24, 'https://picsum.photos/id/1011/100/100', true, 'Kreativt menneske som elsker film, gaming, katte og gÃ¥ture. Lad os mÃ¸des til en god kaffe ðŸ˜Š', 'Aalborg, Denmark', 'INFJ', ARRAY['ðŸ˜‰','ðŸŽ®','â˜•'], true, false),
(2, 'Jens', 26, 'https://picsum.photos/id/1025/100/100', true, 'Elsker natur og brÃ¦tspil.', 'KÃ¸benhavn, Denmark', 'ESTP', ARRAY['ðŸŒ³','ðŸŽ²','ðŸ»'], true, false),
(4, 'Victoria', 25, 'https://picsum.photos/id/1013/100/100', false, 'Bogelsker og museums-entusiast.', 'Aarhus, Denmark', 'INFP', ARRAY['ðŸ“š','ðŸŽ¨','ðŸ›ï¸'], true, false),
(999, 'Mig', 25, 'https://i.pravatar.cc/80?u=999', true, 'SÃ¸ger nye venner at udforske byen med.', 'Odense, Denmark', 'ENFP', ARRAY['ðŸ—ºï¸','ðŸ•','ðŸŽµ'], true, true);

INSERT INTO "public"."interests" ("id", "name") VALUES
(1, 'Gaming'), (2, 'Film'), (3, 'Kaffe'), (4, 'BrÃ¦tspil'), (5, 'Musik'), (6, 'GÃ¥tur'), (7, 'Madlavning'), (8, 'Fotografering'), (9, 'BÃ¸ger');

INSERT INTO "public"."user_interests" ("user_id", "interest_id") VALUES
(1, 1), (1, 2), (1, 3), (1, 6),
(2, 4), (2, 6),
(4, 9),
(999, 5);

INSERT INTO "public"."user_profile_images" ("user_id", "image_url") VALUES
(1, 'https://picsum.photos/seed/cat/200/200'),
(1, 'https://picsum.photos/seed/gaming/200/200'),
(1, 'https://picsum.photos/seed/coffee/200/200');

INSERT INTO "public"."user_traits" ("user_id", "trait", "value") VALUES
(1, 'Abstrakt opfattelse', 70),
(1, 'Emotionel tÃ¦nkning', 80),
(1, 'Rationel tÃ¦nkning', 40),
(1, 'Konkret opfattelse', 60);

INSERT INTO "public"."organizations" ("id", "name", "logo_url", "address", "description") VALUES
(1, 'SIND Ungdom Aalborg', 'https://i.imgur.com/8S8V5c2.png', 'Danmarksgade 52', 'Et tilbud for unge psykisk sÃ¥rbare.'),
(2, 'Studenterhuset Aalborg', 'https://i.imgur.com/fL5FfJ4.png', 'Gammeltorv 10', 'Aalborgs internationale studenterhus.'),
(3, 'Ventilen Aalborg', 'https://i.imgur.com/h5r8uGk.png', 'KirkegÃ¥rdsgade 2', 'Et mÃ¸dested for unge, der fÃ¸ler sig ensomme.');

INSERT INTO "public"."events" ("id", "title", "time", "host_name", "host_avatar_url", "organization_id", "description", "icon", "color", "category", "image_url", "address") VALUES
(1, 'Musik koncert sammen', now() + interval '1 hour', 'Jesper', 'https://i.pravatar.cc/80?u=jesper', 2, 'Kom og hÃ¸r live musik pÃ¥ Studenterhuset!', 'ðŸŽ¸', 'bg-blue-100', 'Musik', 'https://picsum.photos/seed/music/400/300', 'Gammeltorv 10, 9000 Aalborg'),
(2, 'FÃ¦lles spisning', now() + interval '2 hours', 'SIND Ungdom', 'https://i.imgur.com/8S8V5c2.png', 1, 'Hyggelig fÃ¦llesspisning for alle medlemmer.', 'ðŸ”', 'bg-red-100', 'Mad', null, 'Danmarksgade 52, 9000 Aalborg'),
(3, 'FÃ¦lles brÃ¦tspil', now() + interval '1 day', 'Ventilen', 'https://i.imgur.com/h5r8uGk.png', 3, 'Vi finder brÃ¦tspillene frem og hygger.', 'ðŸŽ²', 'bg-green-100', 'BrÃ¦tspil', null, 'KirkegÃ¥rdsgade 2, 9000 Aalborg');

INSERT INTO "public"."places" ("id", "name", "offer", "address", "user_count", "icon", "category", "description", "phone", "opening_hours", "organization_id") VALUES
(1, 'Aalborg BrÃ¦tspilscafe', '2 gratis kaffe', 'NÃ¸rregade 27', 12, 'ðŸŽ²', 'CafÃ©', 'En hyggelig cafe for alle brÃ¦tspilsentusiaster.', '+45 12345678', '14:00 - 23:00', 3);

INSERT INTO "public"."checkins" (place_id, user_id_1, user_id_2) VALUES
(1, 1, 2),
(1, 4, 999);

INSERT INTO "public"."message_threads" ("id", "last_message", "timestamp", "unread_count", "match_timestamp") VALUES
(1, 'Super, er der om 5min vi ses', now() - interval '10 minutes', 0, now() - interval '2 days'),
(2, 'Omg! Vildt samme her!', now() - interval '2 hours', 0, now() - interval '1 day');

INSERT INTO "public"."message_thread_participants" (thread_id, user_id) VALUES
(1, 1), (1, 999),
(2, 2), (2, 999);

INSERT INTO "public"."messages" ("thread_id", "sender_id", "text", "image_url", "created_at") VALUES
(1, 999, 'Hej, hvordan gÃ¥r det?', null, now() - interval '1 day'),
(1, 1, 'Fint, hvad med dig? ðŸ˜Š', null, now() - interval '1 day' + interval '1 minute'),
(1, 999, 'Er du klar til i aften?', null, now() - interval '2 hours'),
(1, 1, 'Yes! GlÃ¦der mig meget!', null, now() - interval '2 hours' + interval '1 minute'),
(1, 1, 'Jeg er her nu ðŸ˜ŠðŸŽ¥', 'https://i.imgur.com/3nQ2nOD.jpg', now() - interval '15 minutes'),
(1, 999, 'Super, er der om 5min vi ses', null, now() - interval '10 minutes'),
(2, 2, 'Omg! Vildt samme her!', null, now() - interval '5 hours');

INSERT INTO "public"."event_participants" (event_id, user_id) VALUES
(1, 1), (1, 2), (2, 4), (3, 1), (3, 4);

INSERT INTO "public"."friends" (user_id_1, user_id_2, status, action_user_id) VALUES
(1, 999, 'accepted', 1), -- Anne and Me are friends
(2, 999, 'pending', 2); -- Jens sent a request to Me

-- Sync primary key sequences
SELECT setval(pg_get_serial_sequence('public.users', 'id'), COALESCE((SELECT MAX(id) FROM public.users), 1));
SELECT setval(pg_get_serial_sequence('public.interests', 'id'), COALESCE((SELECT MAX(id) FROM public.interests), 1));
SELECT setval(pg_get_serial_sequence('public.friends', 'id'), COALESCE((SELECT MAX(id) FROM public.friends), 1));
SELECT setval(pg_get_serial_sequence('public.user_reports', 'id'), COALESCE((SELECT MAX(id) FROM public.user_reports), 1));
SELECT setval(pg_get_serial_sequence('public.checkins', 'id'), COALESCE((SELECT MAX(id) FROM public.checkins), 1));

-- Section 4: Row Level Security (RLS)
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.interests ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_interests ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_profile_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_traits ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organization_opportunities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organization_updates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.places ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.event_participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.message_threads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.message_thread_participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.friends ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.checkins ENABLE ROW LEVEL SECURITY;

-- RLS Policies
-- Users
CREATE POLICY "Allow public read access to users" ON public.users FOR SELECT USING (true);
CREATE POLICY "Allow users to update their own profile" ON public.users FOR UPDATE USING (auth.uid() = auth_id);
CREATE POLICY "Allow users to create their own profile" ON public.users FOR INSERT WITH CHECK (auth.uid() = auth_id);
-- Interests
CREATE POLICY "Allow public read access to interests" ON public.interests FOR SELECT USING (true);
CREATE POLICY "Allow authenticated users to add new interests" ON public.interests FOR INSERT WITH CHECK (auth.role() = 'authenticated');
-- User Interests
CREATE POLICY "Allow users to see all user interests" ON public.user_interests FOR SELECT USING (true);
CREATE POLICY "Allow users to manage their own interests" ON public.user_interests FOR ALL USING (
    (SELECT auth_id FROM public.users WHERE id = user_id) = auth.uid()
);
-- User Profile Images
CREATE POLICY "Allow users to see profile images" ON public.user_profile_images FOR SELECT USING (true);
CREATE POLICY "Allow users to manage their own images" ON public.user_profile_images FOR ALL USING (
    (SELECT auth_id FROM public.users WHERE id = user_id) = auth.uid()
);
-- User Traits
CREATE POLICY "Allow users to manage their own traits" ON public.user_traits FOR ALL USING (
    (SELECT auth_id FROM public.users WHERE id = user_id) = auth.uid()
);
-- Organizations
CREATE POLICY "Allow public read access to organizations" ON public.organizations FOR SELECT USING (true);
CREATE POLICY "Allow organization owner to update their profile" ON public.organizations FOR UPDATE USING (auth.uid() = auth_id);
-- Organization Opportunities & Updates
CREATE POLICY "Allow public read access to organization opportunities" ON public.organization_opportunities FOR SELECT USING (true);
CREATE POLICY "Allow public read access to organization updates" ON public.organization_updates FOR SELECT USING (true);
CREATE POLICY "Allow org owner to manage their opportunities" ON public.organization_opportunities FOR ALL USING ((SELECT auth_id FROM public.organizations WHERE id = organization_id) = auth.uid());
CREATE POLICY "Allow org owner to manage their updates" ON public.organization_updates FOR ALL USING ((SELECT auth_id FROM public.organizations WHERE id = organization_id) = auth.uid());
-- Events
CREATE POLICY "Allow public read access to events" ON public.events FOR SELECT USING (true);
CREATE POLICY "Allow authenticated users to create events" ON public.events FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow org owner to manage their events" ON public.events FOR UPDATE USING ((SELECT auth_id FROM public.organizations WHERE id = organization_id) = auth.uid());
CREATE POLICY "Allow org owner to delete their events" ON public.events FOR DELETE USING ((SELECT auth_id FROM public.organizations WHERE id = organization_id) = auth.uid());
-- Event Participants
CREATE POLICY "Allow public read access to event participants" ON public.event_participants FOR SELECT USING (true);
CREATE POLICY "Allow users to manage their own event participation" ON public.event_participants FOR ALL USING (
    (SELECT auth_id FROM public.users WHERE id = user_id) = auth.uid()
);
-- Places
CREATE POLICY "Allow public read access to places" ON public.places FOR SELECT USING (true);
CREATE POLICY "Allow org owner to manage their places" ON public.places FOR ALL USING ((SELECT auth_id FROM public.organizations WHERE id = organization_id) = auth.uid());
-- Checkins
CREATE POLICY "Allow authenticated users to create checkins" ON public.checkins FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow admins to see all checkins" ON public.checkins FOR SELECT USING ((SELECT is_admin FROM public.users WHERE auth_id = auth.uid()) = true);

-- Messages and Threads
CREATE POLICY "Allow users to access their own threads" ON public.message_threads FOR SELECT USING (
    id IN (
        SELECT thread_id FROM public.message_thread_participants 
        WHERE user_id IN (SELECT id from public.users where auth_id = auth.uid())
    )
);
CREATE POLICY "Allow authenticated users to create threads" ON public.message_threads FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Allow users to see participants of their own threads" ON public.message_thread_participants FOR SELECT USING (
    EXISTS (
        SELECT 1 FROM public.message_thread_participants p
        WHERE p.thread_id = public.message_thread_participants.thread_id
        AND p.user_id = (SELECT id FROM public.users WHERE auth_id = auth.uid())
    )
);
CREATE POLICY "Allow users to add participants if they are friends or themselves" ON public.message_thread_participants FOR INSERT WITH CHECK (
    (user_id = (SELECT id FROM public.users WHERE auth_id = auth.uid()))
    OR
    EXISTS (
        SELECT 1 FROM friends
        WHERE status = 'accepted' AND (
            (user_id_1 = (SELECT id FROM users WHERE auth_id = auth.uid()) AND user_id_2 = public.message_thread_participants.user_id) OR
            (user_id_2 = (SELECT id FROM users WHERE auth_id = auth.uid()) AND user_id_1 = public.message_thread_participants.user_id)
        )
    )
);
CREATE POLICY "Allow users to remove themselves from threads" ON public.message_thread_participants FOR DELETE USING (
    user_id = (SELECT id FROM public.users WHERE auth_id = auth.uid())
);

CREATE POLICY "Allow users to see their own messages" ON public.messages FOR SELECT USING (
    thread_id IN (
        SELECT thread_id FROM public.message_thread_participants 
        WHERE user_id IN (SELECT id from public.users where auth_id = auth.uid())
    )
);
CREATE POLICY "Allow users to send messages in their threads" ON public.messages FOR INSERT WITH CHECK (
    thread_id IN (
        SELECT thread_id FROM public.message_thread_participants 
        WHERE user_id IN (SELECT id from public.users where auth_id = auth.uid())
    )
    AND sender_id IN (SELECT id from public.users where auth_id = auth.uid())
);

-- Friends
CREATE POLICY "Allow users to see their own friendships" ON public.friends FOR SELECT USING (
    (SELECT auth_id FROM public.users WHERE id = user_id_1) = auth.uid() OR
    (SELECT auth_id FROM public.users WHERE id = user_id_2) = auth.uid()
);
CREATE POLICY "Allow users to create friendships" ON public.friends FOR INSERT WITH CHECK (
    (SELECT auth_id FROM public.users WHERE id = action_user_id) = auth.uid()
);
CREATE POLICY "Allow users to update/delete their own friendships" ON public.friends FOR ALL USING (
    (SELECT auth_id FROM public.users WHERE id = user_id_1) = auth.uid() OR
    (SELECT auth_id FROM public.users WHERE id = user_id_2) = auth.uid()
);
-- User Reports
CREATE POLICY "Allow users to create reports" ON public.user_reports FOR INSERT WITH CHECK (
    (SELECT auth_id FROM public.users WHERE id = reporter_user_id) = auth.uid()
);
CREATE POLICY "Allow admins to see all reports" ON public.user_reports FOR SELECT USING (
    (SELECT is_admin FROM public.users WHERE auth_id = auth.uid()) = true
);


-- Section 5: Grants
REVOKE ALL ON ALL TABLES IN SCHEMA public FROM public, anon, authenticated;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO authenticated, anon;
GRANT INSERT, UPDATE, DELETE ON public.users, public.interests, public.user_interests, public.user_profile_images, public.user_traits, public.events, public.event_participants, public.messages, public.friends, public.user_reports, public.organizations, public.places, public.checkins, public.message_threads, public.message_thread_participants TO authenticated;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO authenticated;
REVOKE ALL ON ALL SEQUENCES IN SCHEMA public FROM anon;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO authenticated;

-- Section 6: Stored Procedures & Triggers
-- Drop the old RPC function as it's now replaced by the trigger
DROP FUNCTION IF EXISTS public.create_organization_profile(uuid, text, text, text, text);

-- Function to automatically create an organization profile when a new organization user signs up
CREATE OR REPLACE FUNCTION public.handle_new_organization_user()
RETURNS TRIGGER AS $$
BEGIN
  -- Check if the new user is marked as an organization in their metadata
  IF NEW.raw_user_meta_data->>'is_organization' = 'true' THEN
    -- Insert a corresponding profile into the public.organizations table
    INSERT INTO public.organizations (auth_id, name)
    VALUES (NEW.id, NEW.raw_user_meta_data->>'full_name');
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Assign ownership to the correct Supabase admin role for auth triggers
-- This is critical for the function to have the necessary permissions.
ALTER FUNCTION public.handle_new_organization_user() OWNER TO supabase_auth_admin;

-- Trigger to execute the function after a new user is created
-- Drop existing trigger if it exists, to prevent duplication on re-running script
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_organization_user();