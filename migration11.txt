-- SoulMatch Migration
-- version: 15.1
-- Implements a database-driven activity tag system for organizations and expands the list.

-- 1. Create the new 'activities' table to store predefined activities
CREATE TABLE IF NOT EXISTS "public"."activities" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" text NOT NULL UNIQUE,
    "icon" text NOT NULL, -- Storing the Lucide icon name as text
    "created_at" timestamptz DEFAULT now() NOT NULL
);

-- 2. Create the join table to link organizations to activities
CREATE TABLE IF NOT EXISTS "public"."organization_activities" (
    "organization_id" bigint NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
    "activity_id" bigint NOT NULL REFERENCES public.activities(id) ON DELETE CASCADE,
    PRIMARY KEY (organization_id, activity_id)
);

-- 3. Seed the 'activities' table with a massively expanded list of data
INSERT INTO public.activities (name, icon) VALUES
-- Original
('Fællesspisning', 'Utensils'),
('Brætspil', 'Dice5'),
('Fælles snak', 'MessagesSquare'),
('Musik', 'Music'),
('Kreativt', 'Paintbrush'),
('Gåtur', 'Footprints'),
('Sport', 'Bike'),
('Fester', 'PartyPopper'),
('Foredrag', 'Presentation'),
('Workshops', 'Wrench'),
('Film', 'Film'),
('Natur', 'TreePine'),

-- Kreativt & Hobby
('Tegning', 'PenTool'),
('Maling', 'Paintbrush'),
('Akvarelmaling', 'Paintbrush'),
('Oliemaling', 'Paintbrush'),
('Fotografering', 'Camera'),
('Skrivning', 'FileText'),
('Poesi', 'FileText'),
('Kreativ Skrivning', 'FileText'),
('Keramik', 'Heart'),
('Strikning', 'Scissors'),
('Hækling', 'Scissors'),
('Smykkefremstilling', 'Gem'),
('Træarbejde', 'Hammer'),
('Sæbefremstilling', 'Droplets'),
('Kalligrafi', 'PenTool'),
('Origami', 'File'),
('Modelbygning', 'Ship'),
('Digital Kunst', 'Laptop'),
('Syning', 'Scissors'),
('Bogbinding', 'Book'),
('Tegneserier', 'BookOpen'),
('Skulptur', 'Heart'),
('Graffiti & Street Art', 'Paintbrush'),
('Mode & Design', 'Scissors'),
('Blomsterbinding', 'Flower'),
('Møbelrestaurering', 'Hammer'),
('Glaspustning', 'Droplets'),

-- Sport & Fitness
('Løb', 'Footprints'),
('Cykling', 'Bike'),
('Mountainbike', 'Bike'),
('Svømning', 'Waves'),
('Fodbold', 'Circle'),
('Håndbold', 'Circle'),
('Basketball', 'Circle'),
('Volleyball', 'Circle'),
('Yoga', 'Lotus'),
('Pilates', 'Lotus'),
('Styrketræning', 'Dumbbell'),
('Crossfit', 'Dumbbell'),
('Vandring', 'Mountain'),
('Klatring', 'Mountain'),
('Bouldering', 'Mountain'),
('Dans', 'Music'),
('Zumba', 'Music'),
('Tennis', 'Circle'),
('Badminton', 'Circle'),
('Skateboarding', 'PersonStanding'),
('Rulleskøjter', 'PersonStanding'),
('Kampsport', 'Swords'),
('Boksning', 'Swords'),
('Fægtning', 'Swords'),
('Roning', 'Boat'),
('Sejlsport', 'Sailboat'),
('Surfing', 'Waves'),
('Stand-up Paddle', 'Waves'),
('Kajak', 'Boat'),
('Vinterbadning', 'Snowflake'),
('Golf', 'Golf'),
('Frisbeegolf', 'Circle'),
('Ridning', 'Horse'),
('Gymnastik', 'PersonStanding'),
('Skiløb', 'Snowflake'),
('Snowboarding', 'Snowflake'),
('Ishockey', 'Circle'),

-- Gaming & Tech
('PC Gaming', 'Laptop'),
('Konsol Gaming', 'Gamepad2'),
('Rollespil (D&D)', 'Swords'),
('Magic: The Gathering', 'Book'),
('Warhammer', 'Swords'),
('VR/AR', 'Laptop'),
('Kodning', 'Code'),
('Robotik', 'ToyBrick'),
('Tech-gadgets', 'Smartphone'),
('Anime & Manga', 'BookOpen'),
('Streaming (Twitch)', 'Twitch'),
('Esport', 'Trophy'),
('LAN parties', 'Laptop'),
('Retro-spil', 'Gamepad'),
('Puslespil', 'Puzzle'),
('Kortspil', 'Heart'),
('Mobilspil', 'Smartphone'),
('3D-printning', 'Printer'),
('Droner', 'ToyBrick'),
('Hackathons', 'Code'),

-- Mad & Drikke
('Gourmetmad', 'Utensils'),
('Café-besøg', 'Coffee'),
('Vin-smagning', 'GlassWater'),
('Øl-smagning', 'Beer'),
('Øl-brygning', 'Beer'),
('Cocktails', 'GlassWater'),
('Street food', 'Utensils'),
('Vegetarisk mad', 'Leaf'),
('Vegansk mad', 'Leaf'),
('Dessert', 'Cake'),
('Kaffe', 'Coffee'),
('Brunch', 'Utensils'),
('Mad-festivaller', 'Utensils'),
('Internationalt køkken', 'Globe'),
('Bagekursus', 'Cake'),
('Grill', 'Flame'),
('Madklub', 'Users'),

-- Udendørs & Rejser
('Backpacking', 'Backpack'),
('Camping', 'Tent'),
('Strandture', 'Waves'),
('Skovture', 'Trees'),
('Bjergvandring', 'Mountain'),
('Storbyferie', 'Building2'),
('Kulturrejser', 'Globe'),
('Roadtrips', 'Car'),
('Geocaching', 'MapPin'),
('Fuglekiggeri', 'Bird'),
('Picnic', 'Utensils'),
('Havearbejde', 'Sprout'),
('Fiskeri', 'Fish'),
('Stjernekiggeri', 'Star'),
('Sheltertur', 'Tent'),

-- Socialt & Fællesskab
('Frivilligt arbejde', 'Heart'),
('Bogklub', 'BookOpen'),
('Filmklub', 'Film'),
('Quiz-aftener', 'HelpCircle'),
('Markeder', 'Store'),
('Debatklub', 'MessageSquare'),
('Netværk', 'Users'),
('Lokalpolitik', 'Landmark'),
('Aktivisme', 'Megaphone'),
('Støttegruppe', 'Users'),
('Sprogudveksling', 'Languages'),
('Forældregruppe', 'Baby'),
('Tøseaften', 'PersonStanding'),
('Herreaften', 'PersonStanding'),
('LGBTQ+ Mødested', 'Heart'),
('Internationalt Fællesskab', 'Globe'),

-- Musik & Kultur
('Koncerter', 'Music'),
('Musikfestivaller', 'Music'),
('Spille instrument', 'Guitar'),
('Sang', 'Mic'),
('Kor', 'Users'),
('DJing', 'Disc'),
('Teater', 'Mask'),
('Museum', 'Landmark'),
('Kunstudstillinger', 'Palette'),
('Stand-up comedy', 'Mic'),
('Poesi-oplæsning', 'BookOpen'),
('Opera', 'Mask'),
('Historie', 'Scroll'),
('Arkitektur', 'Building'),
('Impro-teater', 'Theater'),
('Open mic', 'Mic')
ON CONFLICT (name) DO NOTHING;

-- Reset sequence to avoid conflicts if IDs were manually inserted
SELECT setval(pg_get_serial_sequence('public.activities', 'id'), COALESCE((SELECT MAX(id) FROM public.activities), 1));

-- 4. Enable RLS and set policies for the new tables
ALTER TABLE public.activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.organization_activities ENABLE ROW LEVEL SECURITY;

-- Policies for 'activities'
DROP POLICY IF EXISTS "Allow public read access to activities" ON public.activities;
CREATE POLICY "Allow public read access to activities" ON public.activities FOR SELECT USING (true);
DROP POLICY IF EXISTS "Allow admin to manage activities" ON public.activities;
CREATE POLICY "Allow admin to manage activities" ON public.activities FOR ALL USING ((SELECT is_admin FROM public.users WHERE auth_id = auth.uid()) = true);

-- Policies for 'organization_activities'
DROP POLICY IF EXISTS "Allow public read access to organization activities" ON public.organization_activities;
CREATE POLICY "Allow public read access to organization activities" ON public.organization_activities FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow org owners to manage their activities" ON public.organization_activities;
CREATE POLICY "Allow org owners to manage their activities" ON public.organization_activities FOR ALL USING (
    (SELECT auth_id FROM public.organizations WHERE id = organization_id) = auth.uid()
);

-- 5. Grants
GRANT SELECT ON public.activities, public.organization_activities TO authenticated, anon;
GRANT INSERT, UPDATE, DELETE ON public.organization_activities TO authenticated;
GRANT INSERT, UPDATE, DELETE ON public.activities TO authenticated; -- RLS restricts to admins
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO authenticated;