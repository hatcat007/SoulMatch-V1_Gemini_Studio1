-- SoulMatch Migration
-- version: 14.0 (Revised)
-- Implements expanded, categorized interests and a new personality tag system.
-- This script is now self-contained and ensures prerequisite tables exist before modification.
-- WARNING: This script TRUNCATES existing interest data to replace it with a new, curated list.

-- 1. Ensure prerequisite tables and columns from v13 exist
CREATE TABLE IF NOT EXISTS "public"."interest_categories" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" text NOT NULL UNIQUE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

ALTER TABLE public.interests
ADD COLUMN IF NOT EXISTS category_id bigint REFERENCES public.interest_categories(id) ON DELETE SET NULL;


-- 2. Create Personality Tag Tables
CREATE TABLE IF NOT EXISTS "public"."personality_tag_categories" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" text NOT NULL UNIQUE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE IF NOT EXISTS "public"."personality_tags" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" text NOT NULL UNIQUE,
    "category_id" bigint NOT NULL REFERENCES public.personality_tag_categories(id) ON DELETE CASCADE,
    "created_at" timestamptz DEFAULT now() NOT NULL
);

CREATE TABLE IF NOT EXISTS "public"."user_personality_tags" (
    "user_id" bigint NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    "tag_id" bigint NOT NULL REFERENCES public.personality_tags(id) ON DELETE CASCADE,
    PRIMARY KEY (user_id, tag_id)
);

-- 3. Clean up old interest data
TRUNCATE public.user_interests, public.interests, public.interest_categories RESTART IDENTITY CASCADE;

-- 4. Seed new Interest Categories
INSERT INTO public.interest_categories (id, name) VALUES
(1, 'Kreativt & Hobby'),
(2, 'Sport & Fitness'),
(3, 'Gaming & Tech'),
(4, 'Mad & Drikke'),
(5, 'Udendørs & Rejser'),
(6, 'Socialt & Fællesskab'),
(7, 'Musik & Kultur');
SELECT setval(pg_get_serial_sequence('public.interest_categories', 'id'), COALESCE((SELECT MAX(id) FROM public.interest_categories), 1));

-- 5. Seed new Interests (100+ total)
-- Kreativt & Hobby (1)
INSERT INTO public.interests (name, category_id) VALUES
('Tegning', 1), ('Maling', 1), ('Fotografering', 1), ('Skrivning', 1), ('Keramik', 1), ('Strikning', 1),
('Hækling', 1), ('Smykkefremstilling', 1), ('Træarbejde', 1), ('Madlavning', 1), ('Bagning', 1),
('Havearbejde', 1), ('Blomsterbinding', 1), ('Scrapbooking', 1), ('Kalligrafi', 1);
-- Sport & Fitness (2)
INSERT INTO public.interests (name, category_id) VALUES
('Løb', 2), ('Cykling', 2), ('Svømning', 2), ('Fodbold', 2), ('Håndbold', 2), ('Basketball', 2),
('Yoga', 2), ('Pilates', 2), ('Styrketræning', 2), ('Crossfit', 2), ('Vandring', 2), ('Klatring', 2),
('Dans', 2), ('Tennis', 2), ('Badminton', 2), ('Skateboarding', 2);
-- Gaming & Tech (3)
INSERT INTO public.interests (name, category_id) VALUES
('PC Gaming', 3), ('Konsol Gaming', 3), ('Brætspil', 3), ('Rollespil (D&D)', 3), ('Magic: The Gathering', 3),
('Warhammer', 3), ('VR/AR', 3), ('Kodning', 3), ('Robotik', 3), ('Tech-gadgets', 3), ('Anime & Manga', 3),
('Streaming (Twitch)', 3), ('Esport', 3), ('LAN parties', 3), ('Retro-spil', 3);
-- Mad & Drikke (4)
INSERT INTO public.interests (name, category_id) VALUES
('Gourmetmad', 4), ('Café-besøg', 4), ('Vin-smagning', 4), ('Øl-brygning', 4), ('Cocktails', 4),
('Street food', 4), ('Vegetarisk mad', 4), ('Vegansk mad', 4), ('Dessert', 4), ('Kaffe', 4),
('Brunch', 4), ('Mad-festivaller', 4), ('Internationalt køkken', 4);
-- Udendørs & Rejser (5)
INSERT INTO public.interests (name, category_id) VALUES
('Backpacking', 5), ('Camping', 5), ('Strandture', 5), ('Skovture', 5), ('Bjergvandring', 5),
('Kajak/Kano', 5), ('Storbyferie', 5), ('Kulturrejser', 5), ('Roadtrips', 5), ('Geocaching', 5),
('Fuglekiggeri', 5), ('Picnic', 5), ('Stand-up paddle', 5);
-- Socialt & Fællesskab (6)
INSERT INTO public.interests (name, category_id) VALUES
('Frivilligt arbejde', 6), ('Bogklub', 6), ('Filmklub', 6), ('Quiz-aftener', 6), ('Fællesspisning', 6),
('Markeder', 6), ('Debatklub', 6), ('Netværk', 6), ('Lokalpolitik', 6), ('Aktivisme', 6);
-- Musik & Kultur (7)
INSERT INTO public.interests (name, category_id) VALUES
('Koncerter', 7), ('Musikfestivaller', 7), ('Spille instrument', 7), ('Sang', 7), ('DJing', 7),
('Teater', 7), ('Museum', 7), ('Kunstudstillinger', 7), ('Stand-up comedy', 7), ('Film', 7),
('Poesi-oplæsning', 7), ('Opera', 7), ('Historie', 7);
SELECT setval(pg_get_serial_sequence('public.interests', 'id'), COALESCE((SELECT MAX(id) FROM public.interests), 1));


-- 6. Seed Personality Tag Categories
INSERT INTO public.personality_tag_categories (id, name) VALUES
(1, 'Social Stil'),
(2, 'Energi & Tilgang'),
(3, 'Tænkemåde'),
(4, 'Værdier & Holdninger'),
(5, 'Humor & Sjov');
SELECT setval(pg_get_serial_sequence('public.personality_tag_categories', 'id'), COALESCE((SELECT MAX(id) FROM public.personality_tag_categories), 1));

-- 7. Seed Personality Tags (100+ total)
-- Social Stil (1)
INSERT INTO public.personality_tags (name, category_id) VALUES
('Introvert', 1), ('Ekstrovert', 1), ('Ambivert', 1), ('God lytter', 1), ('Snakkesalig', 1), ('Eftertænksom', 1),
('Observant', 1), ('Udadvendt', 1), ('Privat', 1), ('Social sommerfugl', 1), ('Dybe samtaler', 1), ('Smalltalk', 1),
('En-til-en', 1), ('Store grupper', 1), ('Hjemmehygge', 1), ('Byture', 1);
-- Energi & Tilgang (2)
INSERT INTO public.personality_tags (name, category_id) VALUES
('Eventyrlysten', 2), ('Spontan', 2), ('Planlægger', 2), ('Organiseret', 2), ('Afslappet', 2), ('Energisk', 2),
('Rolig', 2), ('Struktureret', 2), ('Fleksibel', 2), ('Morgenmenneske', 2), ('Natteravn', 2), ('Praktisk', 2),
('Kreativ', 2), ('Ambitiøs', 2), ('Nysgerrig', 2), ('Disciplineret', 2);
-- Tænkemåde (3)
INSERT INTO public.personality_tags (name, category_id) VALUES
('Logisk', 3), ('Analytisk', 3), ('Følelsesladet', 3), ('Intuitiv', 3), ('Realistisk', 3), ('Drømmende', 3),
('Optimistisk', 3), ('Pessimistisk', 3), ('Pragmatisk', 3), ('Idealistisk', 3), ('Åbensindet', 3),
('Skeptisk', 3), ('Detaljeorienteret', 3), ('Ser det store billede', 3), ('Filosofisk', 3);
-- Værdier & Holdninger (4)
INSERT INTO public.personality_tags (name, category_id) VALUES
('Empatisk', 4), ('Omsorgsfuld', 4), ('Ærlig', 4), (' loyal', 4), ('Retfærdig', 4), ('Tålmodig', 4),
('Generøs', 4), ('Beskeden', 4), ('Selvsikker', 4), ('Uafhængig', 4), ('Familieorienteret', 4),
('Karrierefokuseret', 4), ('Miljøbevidst', 4), ('Spirituel', 4), ('Traditionel', 4), ('Moderne', 4);
-- Humor & Sjov (5)
INSERT INTO public.personality_tags (name, category_id) VALUES
('Sarkastisk', 5), ('Ironisk', 5), ('Plat humor', 5), ('Tør humor', 5), ('Sort humor', 5), ('Fjollet', 5),
('Spiller med', 5), ('Lattermild', 5), ('Puns', 5), ('Memes', 5), ('Situationsfornemmelse', 5);
SELECT setval(pg_get_serial_sequence('public.personality_tags', 'id'), COALESCE((SELECT MAX(id) FROM public.personality_tags), 1));


-- 8. RLS and Grants for all tables
-- Interest Categories
ALTER TABLE public.interest_categories ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow public read access to interest categories" ON public.interest_categories;
CREATE POLICY "Allow public read access to interest categories" ON public.interest_categories FOR SELECT USING (true);
DROP POLICY IF EXISTS "Allow admin to manage interest categories" ON public.interest_categories;
CREATE POLICY "Allow admin to manage interest categories" ON public.interest_categories FOR ALL USING ((SELECT is_admin FROM public.users WHERE auth_id = auth.uid()) = true);

-- Personality Tag Categories
ALTER TABLE public.personality_tag_categories ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow public read access to personality tag categories" ON public.personality_tag_categories;
CREATE POLICY "Allow public read access to personality tag categories" ON public.personality_tag_categories FOR SELECT USING (true);

-- Personality Tags
ALTER TABLE public.personality_tags ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow public read access to personality tags" ON public.personality_tags;
CREATE POLICY "Allow public read access to personality tags" ON public.personality_tags FOR SELECT USING (true);

-- User Personality Tags
ALTER TABLE public.user_personality_tags ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow users to see all user personality tags" ON public.user_personality_tags;
CREATE POLICY "Allow users to see all user personality tags" ON public.user_personality_tags FOR SELECT USING (true);
DROP POLICY IF EXISTS "Allow users to manage their own personality tags" ON public.user_personality_tags;
CREATE POLICY "Allow users to manage their own personality tags" ON public.user_personality_tags FOR ALL USING (
    (SELECT auth_id FROM public.users WHERE id = user_id) = auth.uid()
);

-- Grants
GRANT SELECT ON public.interest_categories, public.personality_tag_categories, public.personality_tags, public.user_personality_tags TO authenticated, anon;
GRANT INSERT, UPDATE, DELETE ON public.user_personality_tags, public.interest_categories TO authenticated; -- RLS restricts interest_categories to admins
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO authenticated;