-- Migration 16: Re-apply RLS policies for event_images and add for event_interests

-- Re-apply RLS policies for event_images with the correct helper function
ALTER TABLE public.event_images ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Allow public read access to event images" ON public.event_images;
CREATE POLICY "Allow public read access to event images" ON public.event_images FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow event creators to manage event images" ON public.event_images;
CREATE POLICY "Allow event creators to manage event images"
ON public.event_images
FOR ALL
USING (
  ( (SELECT creator_user_id FROM public.events WHERE id = event_id) = get_current_user_id() )
  OR
  ( (SELECT organization_id FROM public.events WHERE id = event_id) IN (SELECT id FROM public.organizations WHERE auth_id = auth.uid()) )
);

-- Add RLS policies for the new event_interests table
ALTER TABLE public.event_interests ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Allow public read access to event interests" ON public.event_interests;
CREATE POLICY "Allow public read access to event interests" ON public.event_interests FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow event creators to manage event interests" ON public.event_interests;
CREATE POLICY "Allow event creators to manage event interests"
ON public.event_interests -- This was the missing part
FOR ALL
USING (
  ( (SELECT creator_user_id FROM public.events WHERE id = event_id) = get_current_user_id() )
  OR
  ( (SELECT organization_id FROM public.events WHERE id = event_id) IN (SELECT id FROM public.organizations WHERE auth_id = auth.uid()) )
);
